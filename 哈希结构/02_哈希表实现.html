<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>哈希表实现</title>
</head>
<body>
  <script>
    // 封装哈希表类
    function HashTable () {
      // 属性
      this.storage = [] // 数组
      this.count = 0  // 数组当前存放了多少个元素了
      this.limit = 7  // 当前数组的总长度

      // 方法
      // 哈希函数
      HashTable.prototype.hashFunc = function(str, size) {
        // 1. 定义hashCode变量
        var hashCode = 0

        // 2. 霍纳算法，来计算hashCode的值
        // cats -> Unicode编码
        for(var i = 0; i < str.length; i++) {
          hashCode = 37 * hashCode + str.charCodeAt(i)
        }

        // 3.取余操作
        var index = hashCode % size
        
        return index
      }

      // 插入&修改操作
      
      //  * 1. 根据key获取索引值
      //  *  目的：将数据插入到对应的位置
      //  * 2. 根据索引值取出bucket
      //  *  1). 如果桶不存在，创建桶，并且防止在该索引的位置
      //  * 3. 判断是新增还是修改原来的值
      //  *  1). 如果已经有值了，那么就修改值；
      //  *  2). 如果没有，执行后续的添加操作
      //  * 4. 新增操作
      //  * 
      HashTable.prototype.put = function (key,value) {
        // 1.根据key获取对应的index
        var index = this.hashFunc(key, this.limit)

        // 2.根据index取出对应的bucket
        var bucket = this.storage[index]

        // 3.判断bucket是否为空
        if(bucket == null) {
          bucket = []
          this.storage[index] = bucket
        }

        // 4.判断是否是修改数据
        for(var i = 0; i < bucket.length; i++) {
          var tuple = bucket[i]
          if(tuple[0] === key) {
            tuple[1] = value
            return
          }
        }

        // 5.进行添加操作
        bucket.push([key,value])
        this.count += 1

        // 6.判断是否需要扩容操作
        if(this.count > this.limit * 0.75) {
          var newNum = this.getPrime(this.limit * 2)
          this.resize(newNum)
        }
      }

      // 获取操作
      /**
       * 1.根据key获取对应的index
       * 2.根据index获取对应的bucket
       * 3.判断bucket是否为null
       * 4.有了bucket，就遍历，并且如果找到，就将对应的value返回即可
       * 5.没有找到，返回null
      */
      HashTable.prototype.get = function (key) {
        // 1.根据key获取对应的index
        var index = this.hashFunc(key, this.limit)

        // 2.根据index取出对应的bucket
        var bucket = this.storage[index]
        
        // 3. 判断bucket是否为空
        if(bucket == null) return null

        for(var i = 0; i < bucket.length; i++) {
          var tuple = bucket[i]
          if(tuple[0] === key) return tuple[1]
        }
        return null
      }

      // 删除操作
      HashTable.prototype.remove = function (key) {
        // 1.获取index
        var index = this.hashFunc(key, this.limit)

        // 2.获取对应的桶
        var bucket = this.storage[index]

        // 3.判断桶是否为空
        if(bucket == null) return null

        // 4.遍历桶，找数据
        for(var i  = 0; i < bucket.length; i++) {
          var tuple = bucket[i]
          if(tuple[0] === key) {
            bucket.splice(i, 1)
            this.count--
            return tuple[1]

            // 缩小容量
            if(this.limit > 7 && this.count < this.limit * 0.25) {
              var newNum = this.getPrime(Math.floor(this.limit/2))
              this.resize(newNum)
            }
          }
        }

        return null
      }

      // 其他方法
      // 判断哈希表是否为空
      HashTable.prototype.isEmpty = function () {
        return this.count == 0
      }

      // 获取哈希表中元素的个数
      HashTable.prototype.size = function () {
        return this.count
      }

      // 哈希表的扩容/缩容
      HashTable.prototype.resize = function (newLimit) {
        // 1. 保存旧的数组内容
        var oldStorage = this.storage

        // 2. 重置所有的属性
        this.storage = []
        this.count = 0
        this.limit = newLimit

        // 3. 遍历oldStorage所有的bucket
        for(var i = 0; i < oldStorage.length; i++) {
          // 3.1取出对应的bucket
          var bucket = oldStorage[i]
          // 3.2判断bucket是否为null
          if(bucket == null) {
            continue
          }
          //3.3 bucket中有数据
          for(var j = 0; j < bucket.length; j++) {
            var tuple = bucket[i]
            this.put(tuple[0], tuple[1])
          }
        }
      }

      HashTable.prototype.isPrime =function(num) {
        // 1.获取num的平方根
        var temp = parseInt(Math.sqrt(num))

        // 2.循坏判断
        for(var i = 0; i <= temp; i++) {
          if(num % i == 0) {
            return false
          }
        }

        return true
      }

      // 获取质数
      HashTable.prototype.getPrime = function (num) {
        while(!isPrime(num)) {
          num++
        }
        return num
      }
    }
    

    // 测试
    var ht = new HashTable()
    ht.put('abc', 123)
    ht.put('111',147)
    ht.put('123',456)
    ht.put('1234',159)
    console.log(ht.storage);
    console.log(ht.get('1234'));
    console.log(ht.remove('123'));
    console.log(ht.storage);
    
    
    
    
    
  </script>
</body>
</html>